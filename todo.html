<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Todo | Teck</title>
  <link rel="stylesheet" href="css/style.css" />

  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'unsafe-inline'; img-src data:; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com">

  <!-- Firebase App (core SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <!-- Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <nav id="main-nav"></nav>

  <div class="todo-container">
    <h2>Todo lijst</h2>
    <form id="todoForm">
      <input type="text" id="todoInput" placeholder="Nieuwe taak toevoegen..." required />
      <button type="submit" class="add-btn">+</button>
    </form>
    <ul id="todoList"></ul>
    <button onclick="goBack()" style="margin-top:1rem; background:#778DA9; color:white; padding:0.5rem 1rem; border:none; border-radius:0.5rem; cursor:pointer;">
      Terug naar dashboard
    </button>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBM03URLmymAoYM-RG9ke40YIrAvTrOuNY",
      authDomain: "teck-personnal.firebaseapp.com",
      projectId: "teck-personnal",
      storageBucket: "teck-personnal.appspot.com",
      messagingSenderId: "877076892450",
      appId: "1:877076892450:web:917be69a1428a8697f737b",
      measurementId: "G-88TT8R5S00"
    };

    // Firebase initialisatie
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const todoForm = document.getElementById('todoForm');
    const todoInput = document.getElementById('todoInput');
    const todoList = document.getElementById('todoList');

    let currentUser = null;

    // Nav laden
    fetch('nav.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('main-nav').innerHTML = data;
      });

    // Terug naar dashboard
    function goBack() {
      window.location.href = 'dashboard.html';
    }

    // User login check
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loadTodos();
      } else {
        // Redirect naar login als niet ingelogd
        window.location.href = 'login.html';
      }
    });

    // Todos realtime laden voor deze gebruiker
    function loadTodos() {
      db.collection('todos')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt')
        .onSnapshot(snapshot => {
          todoList.innerHTML = '';
          snapshot.forEach(doc => {
            const todo = doc.data();
            todo.id = doc.id;

            const li = document.createElement('li');

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = todo.completed;
            checkbox.onchange = () => toggleCompleted(todo.id, checkbox.checked);

            const span = document.createElement('span');
            span.textContent = todo.text;
            if (todo.completed) span.classList.add('completed');

            li.appendChild(checkbox);
            li.appendChild(span);

            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Ã—';
            removeBtn.className = 'remove-btn';
            removeBtn.onclick = (e) => {
              e.stopPropagation();
              deleteTodo(todo.id);
            };

            li.appendChild(removeBtn);
            todoList.appendChild(li);
          });
        });
    }

    // Toggle completed
    function toggleCompleted(id, completed) {
      db.collection('todos').doc(id).update({ completed });
    }

    // Delete todo
    function deleteTodo(id) {
      db.collection('todos').doc(id).delete();
    }

    // Voeg nieuwe todo toe
    todoForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = todoInput.value.trim();
      if (!text) return;

      db.collection('todos').add({
        text: text,
        completed: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        userId: currentUser.uid
      });

      todoInput.value = '';
    });
  </script>
</body>
</html>
